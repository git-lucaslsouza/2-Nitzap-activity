<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WhatsApp Message Execution</title>
  <style>
    body {
      font-family: 'Salesforce Sans', Arial, sans-serif;
      margin: 20px;
      color: #080707;
    }
    #activity-container {
      max-width: 600px;
      margin: 0 auto;
    }
    .status-card {
      background: #ffffff;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0070d2;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .status-message {
      text-align: center;
      margin: 10px 0;
      font-size: 16px;
    }
    .error-message {
      color: #c23934;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 20px;
      display: none;
    }
    .success-message {
      color: #04844b;
      background: #eef7f3;
      padding: 10px;
      border-radius: 4px;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="activity-container">
    <div class="status-card">
      <h2>WhatsApp Message Activity</h2>
      <div id="loading-state">
        <div class="spinner"></div>
        <p class="status-message" id="status-text">Initializing activity...</p>
      </div>
      <div id="error-state" class="error-message">
        <h3>❌ Error</h3>
        <p id="error-text"></p>
      </div>
      <div id="success-state" class="success-message">
        <h3>✅ Success</h3>
        <p id="success-text"></p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/postmonger"></script>
  <script>
    // 1. Initialize Postmonger
    const connection = new Postmonger.Session();
    let activity = {};
    
    // 2. UI Helpers
    function updateStatus(message, type = 'loading') {
      document.getElementById('status-text').textContent = message;
      
      if (type === 'error') {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
        document.getElementById('error-text').textContent = message;
      } 
      else if (type === 'success') {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('success-state').style.display = 'block';
        document.getElementById('success-text').textContent = message;
      }
    }

    // 3. Token Management
    const tokenCache = {
      value: null,
      expires: 0,
      get isValid() {
        return this.value && Date.now() < this.expires;
      },
      set(token, ttlMinutes = 55) {
        this.value = token;
        this.expires = Date.now() + ttlMinutes * 60 * 1000;
      },
      clear() {
        this.value = null;
        this.expires = 0;
      }
    };

    // 4. API Communication
    async function withRetry(fn, maxRetries = 2) {
      let attempt = 0;
      const errors = [];
      
      while (attempt <= maxRetries) {
        try {
          return await fn();
        } catch (error) {
          attempt++;
          errors.push(error.message);
          if (attempt > maxRetries) {
            throw new Error(errors.join(' | '));
          }
          await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
          console.warn(`Retry attempt ${attempt} after error:`, error.message);
        }
      }
    }

    async function getWhatsAppToken(credentials) {
      if (tokenCache.isValid) {
        console.log('Using cached token');
        return tokenCache.value;
      }
      
      updateStatus('Authenticating with WhatsApp API...');
      
      try {
        const response = await withRetry(async () => {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 10000);
          
          const res = await fetch('https://dev.nitzap.com/whatsapp/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(credentials),
            signal: controller.signal
          });
          
          clearTimeout(timeout);
          
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Login failed: ${res.status} - ${errorData}`);
          }
          return res.json();
        });
        
        tokenCache.set(response.sessionToken || response.token);
        return tokenCache.value;
      } catch (error) {
        tokenCache.clear();
        throw error;
      }
    }

    async function sendWhatsAppMessage(config, contactData) {
      // Parse template variables ({{FieldName}})
      const parseTemplate = (text) => 
        text.replace(/\{\{(\w+)\}\}/g, (_, field) => 
          contactData[field] || config[field] || '');
      
      // Get destination number
      const destination = contactData[config.destinationField] || config.destination;
      if (!destination) {
        throw new Error(`No destination phone number found in field: ${config.destinationField}`);
      }
      
      // Prepare message payload
      const message = {
        to: destination,
        message: parseTemplate(config.text),
        type: config.messageType || 'text'
      };
      
      // Add media if needed
      if (message.type !== 'text') {
        message.media = { url: config.mediaUrl };
        if (message.type === 'document') message.media.fileName = config.fileName;
        if (message.type === 'video') message.media.mimetype = config.mimetype || 'video/mp4';
      }
      
      // Get authentication token
      const token = await getWhatsAppToken({
        username: config.numberConnect,
        password: config.secret
      });
      
      // Send message
      updateStatus('Sending WhatsApp message...');
      
      return withRetry(async () => {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000);
        
        const res = await fetch('https://dev.nitzap.com/whatsapp/send-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(message),
          signal: controller.signal
        });
        
        clearTimeout(timeout);
        
        if (!res.ok) {
          const errorData = await res.text();
          throw new Error(`Message send failed: ${res.status} - ${errorData}`);
        }
        
        return res.json();
      });
    }

    // 5. Activity Lifecycle
    connection.on('initActivity', async (payload) => {
      activity = payload;
      
      try {
        const config = activity.arguments?.execute?.inArguments?.[0] || {};
        const contactData = activity.contactData || {};
        
        if (!config.numberConnect || !config.secret) {
          throw new Error('Configuration incomplete - missing credentials');
        }
        
        const result = await sendWhatsAppMessage(config, contactData);
        
        updateStatus(`Message sent to ${result.to} successfully`, 'success');
        
        connection.trigger('updateActivity', {
          status: 'success',
          activityResult: 'Message delivered',
          response: result
        });
        
      } catch (error) {
        console.error('Activity execution failed:', error);
        updateStatus(error.message, 'error');
        
        connection.trigger('updateActivity', {
          status: 'error',
          activityResult: 'Failed to send message',
          error: {
            message: error.message,
            stack: error.stack
          }
        });
      }
    });

    // Signal ready
    connection.trigger('ready');
  </script>
</body>
</html>
